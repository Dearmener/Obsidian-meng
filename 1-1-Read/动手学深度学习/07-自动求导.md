何为自动求导：对于一个方程$y=x^2$ ,自动求导就是使用计算图，将不同阶段的求法放在对应的节点之上。

## 计算图
计算图中，存在着三种元素，函数$y$，操作符$+，-，*，/$，变量$x$，他们按照计算图从上至下排列着；
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 374.4273681640625 343.06514739990234" width="374.4273681640625" height="343.06514739990234">
  <!-- svg-source:excalidraw -->
  
  <defs>
    <style class="style-fonts">
      @font-face {
        font-family: "Virgil";
        src: url("https://excalidraw.com/Virgil.woff2");
      }
      @font-face {
        font-family: "Cascadia";
        src: url("https://excalidraw.com/Cascadia.woff2");
      }
    </style>
    
  </defs>
  <rect x="0" y="0" width="374.4273681640625" height="343.06514739990234" fill="#ffffff"></rect><g stroke-linecap="round" transform="translate(122.28008270263672 10) rotate(0 31 31)"><path d="M29.07 0.07 C35.03 -1.06, 42.76 1.04, 47.99 5.03 C53.23 9.02, 58.69 17.54, 60.48 24.03 C62.27 30.51, 61.39 37.96, 58.73 43.94 C56.06 49.92, 50.61 57.21, 44.47 59.92 C38.33 62.63, 28.52 62.11, 21.87 60.21 C15.21 58.3, 8.14 53.78, 4.55 48.5 C0.96 43.22, -0.54 35.2, 0.32 28.53 C1.19 21.85, 4.54 13.13, 9.74 8.46 C14.95 3.8, 27.39 1.69, 31.54 0.55 C35.7 -0.59, 34.72 1.26, 34.66 1.6 M30.07 -0.59 C36.39 -1.53, 43.77 2.34, 48.87 6.31 C53.98 10.28, 59.04 16.92, 60.7 23.23 C62.36 29.54, 61.74 38.09, 58.83 44.18 C55.91 50.26, 49.41 56.97, 43.2 59.73 C37 62.48, 27.71 62.68, 21.6 60.68 C15.48 58.69, 10.06 53.23, 6.49 47.76 C2.92 42.29, -0.29 34.35, 0.17 27.87 C0.62 21.39, 4.21 13.51, 9.22 8.9 C14.23 4.28, 26.97 1.58, 30.22 0.16 C33.46 -1.26, 28.77 -0.32, 28.71 0.38" stroke="#1e1e1e" stroke-width="1" fill="none"></path></g><g transform="translate(148.66977767384202 28.57968978321702) rotate(0 4.689994812011719 12.5)"><text x="4.689994812011719" y="0" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="text-before-edge">y</text></g><g stroke-linecap="round"><g transform="translate(133.10076904296875 64.58248138427734) rotate(0 -23.251131575647747 43.18535081514157)"><path d="M-0.39 -0.24 C-8.43 14.38, -39.44 73.29, -47.39 87.78 M1.61 -1.41 C-6.62 12.88, -39.68 71.27, -48.11 86.15" stroke="#1e1e1e" stroke-width="1" fill="none"></path></g></g><mask></mask><g stroke-linecap="round"><g transform="translate(180.55694580078125 54.024314880371094) rotate(0 42.24644498191774 50.739774275198585)"><path d="M-1.03 -0.83 C13.18 16.05, 71.12 85.17, 85.52 102.31 M0.63 1.35 C14.65 18.39, 70.51 83.46, 84.48 100.49" stroke="#1e1e1e" stroke-width="1" fill="none"></path></g></g><mask></mask><g stroke-linecap="round" transform="translate(55.05828857421875 150.1831283569336) rotate(0 31 31)"><path d="M39.49 1.6 C45.7 2.65, 52.6 6.8, 56.39 12.11 C60.18 17.42, 62.87 26.54, 62.23 33.45 C61.59 40.37, 57.24 48.77, 52.58 53.59 C47.92 58.4, 40.93 61.77, 34.24 62.32 C27.56 62.87, 18.03 60.9, 12.48 56.9 C6.94 52.91, 2.65 44.91, 0.98 38.37 C-0.68 31.84, -0.39 23.7, 2.51 17.7 C5.4 11.71, 11.9 4.98, 18.37 2.4 C24.83 -0.17, 36.87 1.99, 41.3 2.28 C45.73 2.57, 45.12 3.56, 44.93 4.14 M44.74 4.58 C50.57 7.26, 57.41 14.06, 60.14 20.18 C62.88 26.3, 63.4 35.01, 61.16 41.29 C58.93 47.58, 52.52 54.54, 46.75 57.91 C40.97 61.27, 32.73 62.23, 26.53 61.47 C20.34 60.7, 14.19 57.9, 9.58 53.32 C4.97 48.74, -0.47 40.91, -1.13 33.99 C-1.78 27.08, 1.69 17.17, 5.66 11.83 C9.62 6.49, 16.28 3.5, 22.68 1.96 C29.08 0.41, 40.44 2.1, 44.06 2.54 C47.68 2.98, 44.45 4.17, 44.4 4.6" stroke="#1e1e1e" stroke-width="1" fill="none"></path></g><g transform="translate(80.45798568165452 168.7628181401506) rotate(0 5.67999267578125 12.5)"><text x="5.67999267578125" y="0" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="text-before-edge">u</text></g><g stroke-linecap="round" transform="translate(255.95550537109375 151.71212005615234) rotate(0 31 31)"><path d="M24.23 1.02 C30.32 -1.07, 39.62 -0.66, 45.34 2.37 C51.05 5.4, 55.97 13.02, 58.51 19.22 C61.05 25.41, 62.18 33.29, 60.57 39.54 C58.96 45.78, 54.3 53.08, 48.84 56.68 C43.37 60.29, 34.65 61.86, 27.8 61.19 C20.95 60.52, 12.28 57.18, 7.75 52.66 C3.21 48.14, 1.04 40.86, 0.6 34.07 C0.16 27.28, 0.86 17.5, 5.08 11.91 C9.3 6.31, 21.91 2.47, 25.93 0.5 C29.95 -1.46, 29.03 -0.32, 29.21 0.12 M44.55 2.01 C50.14 4.35, 56.51 11.87, 59.28 18.33 C62.05 24.79, 62.98 34.61, 61.18 40.77 C59.37 46.92, 54.04 51.76, 48.44 55.28 C42.83 58.79, 34.33 62.44, 27.57 61.87 C20.8 61.29, 12.68 56.83, 7.86 51.85 C3.05 46.87, -0.93 38.3, -1.34 32 C-1.76 25.69, 1.24 19.3, 5.35 14.01 C9.46 8.73, 16.64 1.96, 23.31 0.29 C29.97 -1.38, 42 3.41, 45.33 3.98 C48.67 4.54, 43.79 3.44, 43.31 3.68" stroke="#1e1e1e" stroke-width="1" fill="none"></path></g><g transform="translate(281.8051994267717 170.29180983936936) rotate(0 5.2299957275390625 12.5)"><text x="5.2299957275390625" y="0" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="text-before-edge">v</text></g><g stroke-linecap="round" transform="translate(108.1942138671875 269.91808319091797) rotate(0 31 24.5)"><path d="M42.62 1.57 C48.55 2.92, 55.07 7.73, 58.24 12.36 C61.41 16.98, 63.12 24.05, 61.65 29.31 C60.18 34.58, 54.6 40.66, 49.39 43.96 C44.19 47.26, 36.82 49.42, 30.42 49.12 C24.02 48.82, 15.96 45.8, 10.98 42.17 C6 38.54, 1.56 32.62, 0.54 27.35 C-0.48 22.08, 1.27 14.9, 4.86 10.54 C8.45 6.17, 14.92 2.47, 22.1 1.16 C29.27 -0.14, 43.17 1.96, 47.89 2.7 C52.62 3.44, 50.74 5.24, 50.47 5.6 M40.65 1.53 C46.89 2.86, 55.4 6.93, 58.68 11.39 C61.97 15.85, 61.86 23.02, 60.37 28.29 C58.88 33.56, 54.49 39.45, 49.74 43.01 C44.99 46.56, 38.12 49.33, 31.86 49.61 C25.6 49.9, 17.25 48.11, 12.2 44.69 C7.14 41.27, 2.84 34.59, 1.52 29.09 C0.19 23.59, 1.27 16.41, 4.25 11.68 C7.24 6.95, 13.44 2.3, 19.42 0.72 C25.39 -0.85, 36.54 2.04, 40.12 2.24 C43.71 2.43, 41.03 1.83, 40.93 1.87" stroke="#1e1e1e" stroke-width="1" fill="none"></path></g><g transform="translate(126.53391341602952 282.0939670518475) rotate(0 12.739990234375 12.500000000000002)"><text x="12.739990234375" y="0" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="text-before-edge">x2</text></g><g stroke-linecap="round" transform="translate(211.29144287109375 271.06514739990234) rotate(0 31 31)"><path d="M40.06 1.12 C46.35 2.64, 54.79 8.59, 58.25 14.37 C61.72 20.15, 61.9 29.05, 60.85 35.79 C59.79 42.53, 56.59 50.35, 51.92 54.81 C47.25 59.27, 39.46 62.31, 32.84 62.56 C26.23 62.81, 17.57 60.65, 12.23 56.3 C6.9 51.96, 2.33 43.26, 0.83 36.49 C-0.68 29.72, 0.26 21.45, 3.2 15.71 C6.15 9.97, 11.02 3.99, 18.49 2.07 C25.96 0.14, 42.23 2.73, 48.02 4.16 C53.81 5.58, 53.69 10.04, 53.21 10.62 M39.06 2.15 C45.01 2.9, 50.56 6.38, 54.33 11.24 C58.11 16.1, 61.67 24.33, 61.71 31.33 C61.75 38.33, 59.04 48.18, 54.56 53.24 C50.08 58.29, 41.71 60.91, 34.85 61.66 C27.98 62.42, 19.15 61.55, 13.37 57.77 C7.6 54, 2.07 45.42, 0.17 39.03 C-1.72 32.64, -0.81 25.35, 1.99 19.45 C4.78 13.55, 11.15 6.81, 16.96 3.64 C22.77 0.46, 33.24 0.8, 36.86 0.41 C40.48 0.02, 38.42 0.94, 38.7 1.28" stroke="#1e1e1e" stroke-width="1" fill="none"></path></g><g transform="translate(229.94113997852952 289.64483718311936) rotate(0 12.42999267578125 12.5)"><text x="12.42999267578125" y="0" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="text-before-edge">x3</text></g><g stroke-linecap="round" transform="translate(302.4273681640625 266.5366439819336) rotate(0 31 31)"><path d="M34.18 0.42 C40.52 0.45, 49.26 4.6, 53.72 9.16 C58.17 13.72, 60.58 21.34, 60.91 27.78 C61.24 34.22, 59.37 42.19, 55.7 47.81 C52.04 53.43, 45.31 59.56, 38.93 61.5 C32.55 63.45, 23.31 62.47, 17.43 59.47 C11.55 56.48, 6.33 49.54, 3.65 43.55 C0.96 37.55, -0.34 29.77, 1.3 23.51 C2.94 17.25, 7.31 9.65, 13.47 6 C19.64 2.35, 33.87 2.33, 38.31 1.62 C42.74 0.9, 40.36 1.46, 40.07 1.69 M38.08 -0.14 C44.2 0.76, 52.73 5.8, 56.49 11.23 C60.25 16.66, 61.09 25.55, 60.65 32.44 C60.21 39.32, 58.17 47.8, 53.85 52.56 C49.53 57.31, 41.43 60.04, 34.73 60.95 C28.03 61.86, 19.22 61.29, 13.64 58.03 C8.06 54.77, 3.31 47.69, 1.25 41.39 C-0.82 35.08, -1.6 26.34, 1.25 20.21 C4.1 14.07, 12.26 7.72, 18.33 4.58 C24.4 1.44, 34.23 1.83, 37.67 1.38 C41.12 0.92, 39.25 1.25, 39.01 1.83" stroke="#1e1e1e" stroke-width="1" fill="none"></path></g><g transform="translate(321.48706893360765 285.1163337651506) rotate(0 12.019989013671871 12.5)"><text x="12.019989013671875" y="0" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="text-before-edge">x4</text></g><g stroke-linecap="round"><g transform="translate(71.8824462890625 206.9548568725586) rotate(0 -13.327970599140983 27.378143078126012)"><path d="M-0.26 -0.36 C-4.96 8.78, -23.72 46.1, -28.45 55.4 M1.8 -1.59 C-2.48 7.6, -21.44 46.72, -26.12 56.35" stroke="#1e1e1e" stroke-width="1" fill="none"></path></g></g><mask></mask><g stroke-linecap="round"><g transform="translate(107.30615234375 202.85613250732422) rotate(0 12.252895808592442 35.10984837496653)"><path d="M-0.87 0.06 C3.35 11.58, 21.01 58.26, 25.38 70.04 M0.87 -0.96 C4.91 10.62, 20.36 59.01, 24.29 71.18" stroke="#1e1e1e" stroke-width="1" fill="none"></path></g></g><mask></mask><g stroke-linecap="round"><g transform="translate(271.91668701171875 201.97869110107422) rotate(0 -16.683110353853557 36.73241565367207)"><path d="M-0.18 -0.56 C-5.65 11.39, -26.92 60.46, -32.63 72.45 M-1.74 1.76 C-7.31 13.86, -28.12 62.29, -33.18 74.03" stroke="#1e1e1e" stroke-width="1" fill="none"></path></g></g><mask></mask><g stroke-linecap="round"><g transform="translate(305.09368896484375 203.48201751708984) rotate(0 7.445073902979493 31.10149216169492)"><path d="M-0.63 -0.29 C2.1 10.29, 12.83 52.16, 15.52 62.65 M1.24 -1.49 C3.95 9.29, 12.6 52.86, 14.89 63.7" stroke="#1e1e1e" stroke-width="1" fill="none"></path></g></g><mask></mask><g stroke-linecap="round" transform="translate(10 264.8871078491211) rotate(0 31 31)"><path d="M25.75 -0.1 C31.8 -1.55, 40.19 1.43, 46.09 4.82 C51.99 8.21, 58.95 14.21, 61.14 20.25 C63.34 26.29, 61.66 34.64, 59.27 41.06 C56.87 47.47, 52.27 55.38, 46.76 58.75 C41.24 62.11, 32.85 62.6, 26.17 61.23 C19.49 59.86, 11.06 55.61, 6.66 50.52 C2.25 45.43, -0.25 37.17, -0.25 30.7 C-0.26 24.22, 2.2 16.82, 6.66 11.68 C11.11 6.54, 22.89 1.57, 26.48 -0.16 C30.07 -1.89, 27.87 0.75, 28.19 1.29 M30.47 -1.17 C36.88 -1.43, 46.25 4.56, 51.25 9.02 C56.24 13.47, 59.48 19.01, 60.43 25.55 C61.38 32.09, 60.29 42.51, 56.94 48.25 C53.58 53.99, 46.63 58.23, 40.3 59.97 C33.97 61.72, 25.28 61.3, 18.97 58.72 C12.65 56.13, 5.61 49.99, 2.38 44.49 C-0.84 38.98, -1.92 32.1, -0.39 25.7 C1.13 19.3, 6.39 10.6, 11.55 6.1 C16.7 1.6, 27.34 -0.56, 30.55 -1.31 C33.75 -2.07, 30.43 0.75, 30.8 1.58" stroke="#1e1e1e" stroke-width="1" fill="none"></path></g><g transform="translate(32.749695581556864 283.4667976323381) rotate(0 8.329994201660156 12.5)"><text x="8.329994201660156" y="0" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="text-before-edge">x1</text></g></svg>

从根节点的$y$开始到最下面的叶节点，中间经过的路径为操作符，除了叶子节点，其余的变量为中间变量。$y = u*v$ $u= x_1*x_{2}$ $v=x_3*x_4$

当我们在pytorch中运行`y.backward()`时，计算图从上至下的扫描相应的节点，获取对应变量的偏导数，这也就是讲义中的反向累计又称为反向传递。[[1-1-Read/draw/Drawing 2023-11-13 14.48.50.excalidraw.md#^zEWSia8FDh3ltLzuUF0gl|计算图的反向遍历]]
### 计算图和一次性使用
在 PyTorch 中，大多数操作都是在动态计算图上执行的。这个计算图是一个由节点（代表张量）和边（代表从一个张量到另一个张量的操作，如加法或乘法）组成的网络。当您在张量上执行操作时，PyTorch 构建一个记录这些操作的计算图。

当您调用 `loss.backward()` 时，PyTorch 从 `loss` 张量开始，逆向遍历整个计算图，以计算梯度。这个过程称为自动微分或反向传播。
### 自动释放计算图
出于效率和内存管理的考虑，PyTorch 默认在完成 `backward()` 后会自动释放计算图。这意味着用于梯度计算的中间变量和状态都会被清除。释放计算图是必要的，因为在深度学习中，计算图通常只用于一次前向和一次反向传播，然后就不再需要了。
## 对于非标量$y$，为什么可以使用`y.sum`对其进行梯度计算
理解 `y.sum()` 的梯度相对于 `y` 的每个元素都是 1，以及这如何导致计算 `x` 的每个元素关于 `y.sum()` 的梯度，涉及到对梯度计算的基本理解。这里我们可以一步步分解来理解这个过程：
1. **求和操作的梯度**：
   - 当你对一个向量 `y` 的所有元素求和得到 `z = y.sum()` 时，`z` 成为了一个标量。
   - 求和操作的特点是它对每个输入元素的梯度都是 1。换句话说，`z` 相对于 `y` 中的每个元素 `y_i` 的偏导数是 1。这是因为求和操作对每个元素都是线性的，并且系数是 1。
2. **反向传播**：
   - 当调用 `z.backward()` 时，PyTorch 会计算 `z` 相对于其所有依赖的张量的梯度。在这个例子中，它会计算 `z` 相对于 `y`，进而相对于 `x` 的梯度。
   - 由于 `z` 相对于 `y` 的每个元素的偏导数是 1，`y` 中的每个元素对 `z` 的贡献都是它自己的值。这意味着，在反向传播过程中，每个 `y_i` 都会对应地将其梯度（即 1）传递给 `x_i`。
3. **链式法则**：
   - 梯度的计算遵循链式法则。如果 `y = f(x)`，那么 `z = y.sum()` 可以写作 `z = sum(f(x))`。
   - 按照链式法则，$dz/dx_i$ 是 $dz/dy_i$ 乘以 $dy_i/dx_i$。由于我们已经知道 $dz/dy_i$ 是 1，因此 $dz/dx_i$ 等于 $dy_i/dx_i$。
   - 在您的例子中，因为 `y = x * x`，所以 `dy_i/dx_i` 就是 `2 * x_i`。
4. **结果**：
   - 因此，当执行 `y.sum().backward()` 后，计算出的 `x` 的梯度（即 `x.grad`）将反映 `y.sum()` 相对于 `x` 的梯度，这在这个例子中是 `2 * x`。
这就是为什么 `y.sum()` 的梯度相对于 `y` 的每个元素都是 1，从而导致计算 `x` 的每个元素关于 `y.sum()` 的梯度的原因。

